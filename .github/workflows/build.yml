name: Magisk Build

on:
  push:
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    name: Build on ubuntu-latest
    runs-on: ubuntu-latest

    steps:
      - name: Check out
        uses: actions/checkout@main
        with:
          submodules: 'recursive'
          fetch-depth: 0

      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt update
          sudo -E apt full-upgrade -y
          sudo -E apt dist-upgrade -y
          sudo -E apt autoremove --purge
          sudo -E apt clean

      - name: Set up JDK
        uses: actions/setup-java@main
        with:
          distribution: 'temurin'
          java-version: '19'

      - name: Set up Python 3.11
        uses: actions/setup-python@main
        with:
          python-version: '3.11'

      - name: Set up NDK
        run: |
          pip3.11 install colorama
          python3.11 build.py -r ndk

      - name: Build release
        run: |
          python3.11 build.py -r all

      - name: Upload build artifact
        uses: actions/upload-artifact@main
        with:
          name: ${{ github.sha }}
          path: out
